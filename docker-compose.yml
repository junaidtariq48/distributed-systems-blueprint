version: "3.9"

services:
  # ========= Infrastructure =========
  nats:
    image: nats:2.10
    command: ["-js", "-m", "8222"]
    ports:
      - "4222:4222"
      - "8222:8222"

  postgres:
    image: postgres:16
    environment:
      POSTGRES_USER: app
      POSTGRES_PASSWORD: app
      POSTGRES_DB: app
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data

  # ========= Observability =========
  otel-collector:
    image: otel/opentelemetry-collector-contrib:0.93.0
    command: ["--config=/etc/otelcol/config.yaml"]
    volumes:
      - ./infra/otel-collector.yaml:/etc/otelcol/config.yaml:ro
    ports:
      - "4318:4318"  # OTLP HTTP
      - "8889:8889"  # Prometheus exporter

  tempo:
    image: grafana/tempo:latest
    command: ["-config.file=/etc/tempo.yaml"]
    volumes:
      - ./infra/tempo.yaml:/etc/tempo.yaml:ro
      - tempo-data:/var/tempo
    ports:
      - "3200:3200"   # Tempo query
      - "4317:4317"   # OTLP gRPC (not used here)
      - "4319:4319"   # OTLP HTTP (Tempo can accept, but we route via collector)

  prometheus:
    image: prom/prometheus:v2.49.1
    volumes:
      - ./infra/prometheus.yaml:/etc/prometheus/prometheus.yml:ro
    ports:
      - "9090:9090"

  loki:
    image: grafana/loki:2.9.4
    command: ["-config.file=/etc/loki/local-config.yaml"]
    ports:
      - "3100:3100"

  promtail:
    image: grafana/promtail:2.9.4
    volumes:
      - ./infra/promtail.yaml:/etc/promtail/config.yml:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    command: ["-config.file=/etc/promtail/config.yml"]

  grafana:
    image: grafana/grafana:10.3.1
    ports:
      - "3000:3000"
    volumes:
      - ./infra/grafana-datasources.yaml:/etc/grafana/provisioning/datasources/datasources.yaml:ro
      - ./infra/grafana/provisioning/dashboards/dashboards.yaml:/etc/grafana/provisioning/dashboards/dashboards.yaml:ro
      - ./infra/grafana/dashboards:/var/lib/grafana/dashboards:ro
      - grafana-data:/var/lib/grafana
    depends_on:
      - prometheus
      - tempo
      - loki

  # ========= Apps =========
  api-gateway:
    build:
      context: .
      dockerfile: ./infra/Dockerfile
      args:
        APP: api-gateway
    env_file: .env
    ports:
      - "3001:3001"
    depends_on:
      - nats
      - otel-collector

  users-service:
    build:
      context: .
      dockerfile: ./infra/Dockerfile
      args:
        APP: users-service
    env_file: .env
    ports:
      - "3002:3002"
    depends_on:
      - otel-collector

  orders-service:
    build:
      context: .
      dockerfile: ./infra/Dockerfile
      args:
        APP: orders-service
    env_file: .env
    ports:
      - "3003:3003"
    depends_on:
      - postgres
      - nats
      - otel-collector

  notifications-service:
    build:
      context: .
      dockerfile: ./infra/Dockerfile
      args:
        APP: notifications-service
    env_file: .env
    depends_on:
      - nats
      - otel-collector

volumes:
  pgdata:
  tempo-data:
  grafana-data:
